<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CVSITE - Mod Uploader</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
    input, button, textarea { padding: 8px; margin: 4px; }
    .mod { border: 1px solid #444; padding: 10px; margin: 10px 0; }
    .container { max-width: 800px; margin: 0 auto; }
    h2 { text-align: center; }
    #upload { display: none; }
  </style>
</head>
<body>

<div class="container">
  <h2>Welcome to CVSITE</h2>
  <p>Upload your favorite mods and share them with others! Sign up or log in to get started.</p>

  <!-- Auth Section -->
  <div id="auth">
    <input id="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Log In</button>
    <button onclick="signOut()">Log Out</button>
  </div>

  <!-- Upload Section -->
  <div id="upload" style="display:none;">
    <h3>Submit a Mod</h3>
    <input id="modName" placeholder="Mod Name"><br>
    <input id="modLink" placeholder="GoFile or Download Link"><br>
    <textarea id="modDesc" placeholder="Short description" rows="3" cols="40"></textarea><br>
    <button onclick="submitMod()">Submit Mod</button>
  </div>

  <!-- Mod List -->
  <h3>Uploaded Mods</h3>
  <div id="modsList"></div>
</div>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBtGwQeKlQCQpTv8Lzav7djmka6YQMIORI",
    authDomain: "cvsite-fe8b5.firebaseapp.com",
    projectId: "cvsite-fe8b5",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUserRole = "viewer"; // Default role

  // Authentication Functions
  function signUp() {
    const nickname = prompt("Enter your nickname:"); // Get nickname

    auth.createUserWithEmailAndPassword(email.value, password.value)
      .then(() => {
        alert("Signed up!");
        // Store user role and nickname in Firestore
        db.collection("roles").doc(email.value).set({ 
          role: "viewer", 
          nickname: nickname || "Guest"
        });
      })
      .catch(error => alert(error.message));
  }

  function signIn() {
    auth.signInWithEmailAndPassword(email.value, password.value)
      .then(() => alert("Logged in!"))
      .catch(error => alert(error.message));
  }

  function signOut() {
    auth.signOut()
      .then(() => alert("Logged out"))
      .catch(error => alert(error.message));
  }

  // Monitor Auth State
  auth.onAuthStateChanged(async user => {
    if (user) {
      // Get user's role and nickname from Firestore
      const doc = await db.collection("roles").doc(user.email).get();
      currentUserRole = doc.exists ? doc.data().role : "viewer";
      const nickname = doc.exists ? doc.data().nickname : "Guest";

      // Show mod upload form for admins and uploaders
      upload.style.display = (currentUserRole === "admin" || currentUserRole === "uploader") ? "block" : "none";
      
      // Set the global nickname
      window.currentNickname = nickname;
    } else {
      upload.style.display = "none"; // Hide upload form if not logged in
    }
  });

  // Submit Mod Function
  function submitMod() {
    const mod = {
      name: modName.value,
      link: modLink.value,
      desc: modDesc.value,
      uploader: window.currentNickname, // Display nickname
      time: new Date().toISOString()
    };

    // Add mod data to Firestore
    db.collection("mods").add(mod)
      .then(() => {
        alert("Mod submitted!");
        modName.value = modLink.value = modDesc.value = ""; // Reset fields
      })
      .catch(error => alert(error.message));
  }

  // Display Mods
  db.collection("mods").orderBy("time", "desc").onSnapshot(snapshot => {
    modsList.innerHTML = ""; // Clear the list
    snapshot.forEach(doc => {
      const mod = doc.data();
      modsList.innerHTML += `
        <div class="mod">
          <strong>${mod.name}</strong><br>
          <small>By: ${mod.uploader}</small><br>
          <p>${mod.desc || ""}</p>
          <a href="${mod.link}" target="_blank">Download</a> <!-- Download button -->
        </div>
      `;
    });
  });
</script>

</body>
</html>
